# Диагностика проверки подписки

## Проблема
Система разрешает повторную оплату даже при существующей активной подписке.

## Как проверить, что происходит

### Шаг 1: Откройте консоль браузера
1. Откройте страницу оплаты: `payment.html`
2. Нажмите `F12` или `Cmd+Option+I` (Mac) чтобы открыть DevTools
3. Перейдите на вкладку **Console**

### Шаг 2: Проверьте, что возвращает API
1. В консоли выполните команду:
```javascript
fetch('https://new-landing-production.up.railway.app/api/check_subscription?username=ВАШ_USERNAME')
  .then(r => r.json())
  .then(data => {
    console.log('Ответ API:', data);
    console.log('Тип:', typeof data);
    console.log('Ключи:', Object.keys(data || {}));
  })
  .catch(e => console.error('Ошибка:', e));
```

Замените `ВАШ_USERNAME` на ваш Telegram username (без @)

### Шаг 3: Попробуйте оплатить повторно
1. Введите ваш Telegram username
2. Выберите тариф
3. Нажмите "Оплатить"
4. Смотрите в консоль - должны появиться логи:
   - `=== НАЧАЛО ПРОВЕРКИ ПОДПИСКИ ===`
   - `Результат проверки подписки: ...`
   - `=== ПРОВЕРКА ЗАВЕРШЕНА: ... ===`

## Что проверить

### 1. Работает ли endpoint `/check_subscription`?
Если при вызове из консоли вы получаете ошибку 404 или другую ошибку - endpoint не работает.

### 2. Какой формат данных возвращает API?
API должен возвращать один из вариантов:
- `{ "has_subscription": true }`
- `{ "subscription_exists": true }`
- `{ "is_active": true }`
- `{ "active": true }`
- `{ "status": "active" }`
- Или объект с полями `tariff_name`, `expires_at` и т.д.

### 3. Что показывается в логах?
Когда вы пытаетесь оплатить, в консоли должны быть логи:
- Если подписка найдена: `❌ ПОДПИСКА НАЙДЕНА! Блокируем оплату.`
- Если подписка не найдена: `✅ Подписка не найдена. Продолжаем создание платежа...`

## Возможные проблемы

### Проблема 1: API endpoint не существует
**Решение:** Нужно проверить настройки API сервиса в Railway

### Проблема 2: API возвращает другой формат
**Решение:** Нужно скорректировать логику проверки в `payment.js` под ваш формат

### Проблема 3: Проверка не выполняется
**Решение:** Проверить, что код не пропускает проверку

## Что делать дальше

После проверки:
1. Скопируйте логи из консоли
2. Проверьте, что возвращает API endpoint
3. Сообщите результаты для дальнейшей настройки



